# Requirements Document

## Introduction

This feature enhances the existing hybrid search system to better handle natural language queries. The current implementation has limitations with keyword search configuration, semantic search weights, query preprocessing, and image embedding quality. This enhancement uses AWS Bedrock Claude models to:
1. Generate rich natural language descriptions of product images during indexing (Claude 3 Sonnet multimodal)
2. Analyze search queries in real-time for language detection, intent classification, and term expansion (Claude 3 Haiku)
3. Optimize hybrid search for both Chinese and English natural language queries

**Design Philosophy**: Instead of building complex rule-based query preprocessing with synonym maps and pattern matching, we leverage Claude's language understanding capabilities. This is simpler, more flexible, and handles edge cases better than hand-crafted rules.

## Glossary

- **Image_Description_Generator**: A service that uses Claude 3 Sonnet multimodal model to generate rich natural language descriptions of product images
- **Query_Analyzer**: A service that uses Claude 3 Haiku to analyze search queries, detecting language, classifying intent, and expanding search terms
- **Hybrid_Search_Engine**: The existing OpenSearch-based search system that combines keyword matching and semantic vector similarity
- **Embedding_Service**: The existing AWS Bedrock-based service that generates text and image embeddings
- **Query_Intent**: The detected purpose or type of a search query (e.g., product type search, attribute search, style search)
- **Result_Diversifier**: A component that ensures search results show variety across categories

## Requirements

### Requirement 1: Rich Image Description Generation

**User Story:** As a product manager, I want product images to have rich natural language descriptions generated by AI, so that users can find products by describing visual characteristics in their search queries.

#### Acceptance Criteria

1. WHEN a product is indexed, THE Image_Description_Generator SHALL analyze the product thumbnail using Claude 3 Sonnet multimodal model
2. WHEN generating image descriptions, THE Image_Description_Generator SHALL produce descriptions in both English and Chinese
3. WHEN generating image descriptions, THE Image_Description_Generator SHALL include visual attributes such as color, style, material appearance, shape, and design elements
4. WHEN generating image descriptions, THE Image_Description_Generator SHALL produce descriptions between 50-200 words per language
5. THE Image_Description_Generator SHALL store generated descriptions in a new `image_description_en` and `image_description_zh` field in the product document
6. WHEN image description generation fails, THE Image_Description_Generator SHALL fall back to existing Rekognition labels
7. THE Image_Description_Generator SHALL include the image descriptions in the searchable text embedding

### Requirement 2: AI-Powered Query Analysis

**User Story:** As a user, I want my natural language search queries to be intelligently analyzed by AI, so that I get relevant results even when using informal language, synonyms, or different languages.

#### Acceptance Criteria

1. WHEN a search query is received, THE Query_Analyzer SHALL use Claude 3 Haiku to analyze the query in real-time
2. WHEN analyzing a query, THE Query_Analyzer SHALL detect the language as 'en', 'zh', or 'mixed'
3. WHEN analyzing a query, THE Query_Analyzer SHALL classify the intent into categories: product_type, attribute, style, use_case, or general
4. WHEN analyzing a query, THE Query_Analyzer SHALL expand the query with synonyms and related terms in both English and Chinese
5. WHEN analyzing a query, THE Query_Analyzer SHALL suggest optimal keyword/semantic weights based on query characteristics
6. THE Query_Analyzer SHALL preserve the original query terms in the expanded terms list

### Requirement 3: Dynamic Search Weight Optimization

**User Story:** As a user, I want the search system to automatically adjust how it searches based on my query type, so that I get the most relevant results.

#### Acceptance Criteria

1. WHEN the query intent is product_type (e.g., "sofa", "chair"), THE Query_Analyzer SHALL suggest keyword weight >= 0.6
2. WHEN the query intent is style or use_case (e.g., "modern minimalist", "for small apartment"), THE Query_Analyzer SHALL suggest semantic weight >= 0.6
3. WHEN the query intent is attribute (e.g., "blue leather"), THE Query_Analyzer SHALL suggest balanced weights (0.4-0.6)
4. THE Hybrid_Search_Engine SHALL allow manual weight override via API parameters
5. THE Hybrid_Search_Engine SHALL return the applied weights in the response metadata

### Requirement 4: Enhanced Keyword Search Configuration

**User Story:** As a user, I want keyword search to better match my natural language queries, so that I find products even when using different phrasings.

#### Acceptance Criteria

1. THE Hybrid_Search_Engine SHALL search the `subtitle` field with appropriate weight
2. THE Hybrid_Search_Engine SHALL increase the `description` field weight for better natural language matching
3. THE Hybrid_Search_Engine SHALL use `cross_fields` type for multi_match queries to better handle natural language
4. THE Hybrid_Search_Engine SHALL search the new `image_description_en` and `image_description_zh` fields
5. WHEN a query is detected as Chinese, THE Hybrid_Search_Engine SHALL prioritize Chinese description fields
6. WHEN a query is detected as English, THE Hybrid_Search_Engine SHALL prioritize English description fields

### Requirement 5: Bilingual Search Support

**User Story:** As a user who speaks Chinese or English, I want to search in my preferred language and find relevant products, so that I can shop comfortably in my native language.

#### Acceptance Criteria

1. THE Query_Analyzer SHALL detect query language using AI analysis
2. WHEN indexing products, THE Image_Description_Generator SHALL generate descriptions in both English and Chinese
3. THE Hybrid_Search_Engine SHALL select the appropriate description field based on detected query language
4. WHEN a query contains mixed languages, THE Query_Analyzer SHALL expand terms in both languages
5. THE Query_Analyzer SHALL support common Chinese e-commerce search terms and their English equivalents

### Requirement 6: Search Result Diversity

**User Story:** As a user, I want search results to show a variety of relevant products, so that I can explore different options that match my query.

#### Acceptance Criteria

1. WHEN merging hybrid search results, THE Hybrid_Search_Engine SHALL consider result diversity in addition to relevance scores
2. THE Hybrid_Search_Engine SHALL avoid showing too many products from the same category in top results
3. THE Hybrid_Search_Engine SHALL implement a diversity factor that can be configured via API parameters
4. IF two products have similar scores, THE Hybrid_Search_Engine SHALL prefer the one from a different category

### Requirement 7: Cross-Language Term Expansion

**User Story:** As a user, I want to find products even when I use different words than the product listing, so that I don't miss relevant items.

#### Acceptance Criteria

1. THE Query_Analyzer SHALL expand queries with synonyms and related terms using AI
2. THE Query_Analyzer SHALL include cross-language equivalents (e.g., sofa ↔ 沙发)
3. WHEN expanding terms, THE Query_Analyzer SHALL preserve the original term in the search
4. THE expanded terms SHALL be used in the keyword search query

