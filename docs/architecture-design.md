# PLP 搜索功能架构设计

## 一、业务背景与痛点分析

### 1.1 业务场景

电商平台的产品列表页（PLP - Product Listing Page）是用户购物旅程中的核心触点。用户期望能够：

- 通过关键词快速找到目标商品
- 通过多维度筛选缩小选择范围（分类、价格、属性等）
- 获得与搜索意图相关的结果排序

### 1.2 现有方案的痛点

| 痛点 | 具体表现 | 业务影响 |
|------|----------|----------|
| **搜索能力弱** | 仅支持精确匹配，无法处理模糊搜索、同义词 | 用户找不到商品，转化率下降 |
| **过滤维度单一** | 无法支持多维度 Faceted 过滤 | 用户筛选效率低，体验差 |
| **性能瓶颈** | 大数据量下数据库查询慢 | 页面加载慢，用户流失 |
| **排序不智能** | 无法按相关性排序 | 搜索结果不符合用户预期 |

### 1.3 目标方案

构建一个**专业级的搜索体验**，支持：
- 全文搜索（Full-text Search）
- 多维度 Faceted 过滤
- 相关性排序
- 毫秒级响应


---

## 二、领域驱动设计（DDD）分析

### 2.1 领域识别

通过对业务场景的分析，我们识别出两个核心领域：

```
┌─────────────────────────────────────────────────────────────┐
│                      电商平台                                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌─────────────────────┐       ┌─────────────────────┐     │
│   │    Product Domain   │       │    Search Domain    │     │
│   │      (产品领域)      │       │      (搜索领域)      │     │
│   │                     │       │                     │     │
│   │  • 产品生命周期管理   │       │  • 搜索索引管理      │     │
│   │  • 库存与价格        │       │  • 全文检索          │     │
│   │  • 分类与标签        │       │  • Faceted 过滤     │     │
│   │  • 业务规则验证      │       │  • 相关性排序        │     │
│   │                     │       │                     │     │
│   └─────────────────────┘       └─────────────────────┘     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 领域边界与职责

#### Product Domain（产品领域）

**核心职责**：产品数据的权威来源，负责所有产品相关的业务逻辑

| 聚合根 | 职责 | 关键行为 |
|--------|------|----------|
| Product | 产品实体管理 | 创建、更新、发布、下架 |
| Category | 分类体系 | 层级管理、产品归类 |
| Collection | 产品集合 | 营销分组、专题管理 |

**数据特征**：
- 强一致性要求
- 事务性操作
- 复杂的业务规则验证

#### Search Domain（搜索领域）

**核心职责**：提供高性能的产品检索能力

| 核心概念 | 职责 | 关键能力 |
|----------|------|----------|
| ProductDocument | 搜索文档 | 扁平化的可搜索结构 |
| SearchIndex | 索引管理 | 索引创建、更新、删除 |
| Facet | 聚合维度 | 分类、价格区间、属性 |

**数据特征**：
- 最终一致性可接受
- 读优化的数据结构
- 高并发查询支持


### 2.3 为什么要分离两个领域？

**关键洞察**：产品管理和产品搜索是两个本质不同的业务关注点

| 维度 | Product Domain | Search Domain |
|------|----------------|---------------|
| **核心关注** | 数据正确性 | 查询性能 |
| **一致性要求** | 强一致性 | 最终一致性 |
| **数据结构** | 规范化（3NF） | 反规范化（扁平化） |
| **操作特征** | 读写均衡 | 读密集型 |
| **扩展方向** | 垂直扩展 | 水平扩展 |

这种分离体现了 **CQRS（命令查询职责分离）** 的思想：
- **Command（写）**：通过 Product Domain 处理
- **Query（读）**：通过 Search Domain 优化

---

## 三、领域模型设计

### 3.1 Product Domain 模型

```
┌─────────────────────────────────────────────────────────────┐
│                    Product Aggregate                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────┐                                            │
│  │   Product   │ (聚合根)                                    │
│  │  ─────────  │                                            │
│  │  id         │                                            │
│  │  title      │                                            │
│  │  handle     │                                            │
│  │  status     │◀─── published | draft                      │
│  │  description│                                            │
│  └──────┬──────┘                                            │
│         │                                                    │
│         │ 1:N                                                │
│         ▼                                                    │
│  ┌─────────────┐      ┌─────────────┐                       │
│  │   Variant   │      │    Price    │                       │
│  │  ─────────  │ 1:N  │  ─────────  │                       │
│  │  sku        │─────▶│  amount     │                       │
│  │  title      │      │  currency   │                       │
│  └─────────────┘      └─────────────┘                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────┐     ┌─────────────────┐
│    Category     │     │   Collection    │
│   ───────────   │     │   ───────────   │
│   id            │     │   id            │
│   name          │     │   title         │
│   parent_id     │     │   handle        │
└─────────────────┘     └─────────────────┘
        │                       │
        └───────────┬───────────┘
                    │ M:N
                    ▼
              ┌───────────┐
              │  Product  │
              └───────────┘
```


### 3.2 Search Domain 模型

```
┌─────────────────────────────────────────────────────────────┐
│                   ProductDocument                            │
│              (搜索优化的扁平化文档)                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  基础信息                                            │    │
│  │  ─────────                                          │    │
│  │  id, title, handle, thumbnail, description          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  分类维度 (Facets)                                   │    │
│  │  ─────────                                          │    │
│  │  category_ids: ["cat_1", "cat_2"]                   │    │
│  │  category_names: ["Living Room", "Sofas"]           │    │
│  │  collection_ids: ["col_1"]                          │    │
│  │  collection_names: ["Summer Sale"]                  │    │
│  │  tag_values: ["new", "bestseller"]                  │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  价格区间                                            │    │
│  │  ─────────                                          │    │
│  │  min_price: 29900  (最低变体价格)                    │    │
│  │  max_price: 59900  (最高变体价格)                    │    │
│  │  currency_code: "usd"                               │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  产品属性 (动态 Facets)                              │    │
│  │  ─────────                                          │    │
│  │  meta_material: "Leather"                           │    │
│  │  meta_care: "Dry clean only"                        │    │
│  │  option_values: ["Red", "Blue", "Large", "Small"]   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**设计要点**：

1. **扁平化结构**：将嵌套的关联数据（分类、集合、标签）展开为数组，便于搜索引擎索引
2. **预计算聚合**：`min_price`/`max_price` 在索引时计算，避免查询时聚合
3. **多值字段**：`category_names` 等使用数组，支持多选过滤

---

## 四、领域事件设计

### 4.1 事件识别

从业务场景出发，识别关键的领域事件：

| 业务动作 | 领域事件 | 事件含义 |
|----------|----------|----------|
| 创建产品 | `ProductCreated` | 新产品进入系统 |
| 更新产品 | `ProductUpdated` | 产品信息变更 |
| 发布产品 | `ProductPublished` | 产品上架可售 |
| 下架产品 | `ProductUnpublished` | 产品不再可售 |
| 删除产品 | `ProductDeleted` | 产品从系统移除 |


### 4.2 事件流转设计

```
┌─────────────────────────────────────────────────────────────┐
│                    Event Flow Design                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐                                           │
│  │  Admin User  │                                           │
│  └──────┬───────┘                                           │
│         │ 创建/更新/删除产品                                  │
│         ▼                                                    │
│  ┌──────────────┐                                           │
│  │   Product    │                                           │
│  │   Domain     │                                           │
│  └──────┬───────┘                                           │
│         │                                                    │
│         │ 发布领域事件                                        │
│         ▼                                                    │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                    Event Bus                          │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────────┐    │   │
│  │  │ Product    │ │ Product    │ │ Product        │    │   │
│  │  │ Created    │ │ Updated    │ │ Deleted        │    │   │
│  │  └─────┬──────┘ └─────┬──────┘ └───────┬────────┘    │   │
│  └────────┼──────────────┼────────────────┼─────────────┘   │
│           │              │                │                  │
│           └──────────────┼────────────────┘                  │
│                          │                                   │
│                          ▼                                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Event Handlers (Subscribers)             │   │
│  │                                                       │   │
│  │  ┌─────────────────────────────────────────────────┐ │   │
│  │  │  ProductSyncHandler                             │ │   │
│  │  │  ─────────────────                              │ │   │
│  │  │  监听: ProductCreated, ProductUpdated           │ │   │
│  │  │  动作: 同步产品到搜索索引                         │ │   │
│  │  └─────────────────────────────────────────────────┘ │   │
│  │                                                       │   │
│  │  ┌─────────────────────────────────────────────────┐ │   │
│  │  │  ProductDeleteHandler                           │ │   │
│  │  │  ─────────────────                              │ │   │
│  │  │  监听: ProductDeleted                           │ │   │
│  │  │  动作: 从搜索索引删除产品                         │ │   │
│  │  └─────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
│                          │                                   │
│                          ▼                                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                  Search Domain                        │   │
│  │                  (OpenSearch)                         │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 事件处理策略

| 事件 | 处理策略 | 原因 |
|------|----------|------|
| `ProductCreated` | 异步索引 | 不阻塞创建流程 |
| `ProductUpdated` | 异步更新 | 允许短暂不一致 |
| `ProductDeleted` | 异步删除 | 搜索结果可容忍短暂延迟 |

**最终一致性保证**：
- 事件处理失败时重试
- 提供手动全量同步能力作为兜底


---

## 五、数据同步流程设计

### 5.1 同步流程编排

将复杂的同步逻辑拆分为可组合的步骤：

```
┌─────────────────────────────────────────────────────────────┐
│                   Sync Workflow                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Input: { productId? | limit, offset }                      │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Step 1: Query Products                             │    │
│  │  ─────────────────────                              │    │
│  │  从 Product Domain 获取产品数据                      │    │
│  │  包含: 基本信息、分类、集合、标签、变体、价格         │    │
│  └─────────────────────────────────────────────────────┘    │
│                          │                                   │
│                          ▼                                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Step 2: Transform Data                             │    │
│  │  ─────────────────────                              │    │
│  │  将领域模型转换为搜索文档                            │    │
│  │                                                     │    │
│  │  Product (规范化)  ──▶  ProductDocument (扁平化)     │    │
│  │                                                     │    │
│  │  • 展开嵌套关系为数组                                │    │
│  │  • 计算 min_price / max_price                       │    │
│  │  • 分离 published / unpublished                     │    │
│  └─────────────────────────────────────────────────────┘    │
│                          │                                   │
│              ┌───────────┴───────────┐                      │
│              ▼                       ▼                      │
│  ┌─────────────────────┐  ┌─────────────────────┐          │
│  │  Step 3a: Index     │  │  Step 3b: Delete    │          │
│  │  ─────────────────  │  │  ─────────────────  │          │
│  │  索引已发布产品      │  │  删除未发布产品      │          │
│  │  到 Search Domain   │  │  从 Search Domain   │          │
│  └─────────────────────┘  └─────────────────────┘          │
│                                                              │
│  Output: { synced_count, deleted_count }                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 数据转换规则

```
┌─────────────────────────────────────────────────────────────┐
│              Data Transformation Rules                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Product Domain Model          Search Document               │
│  ────────────────────          ───────────────               │
│                                                              │
│  product.id              ──▶   id                           │
│  product.title           ──▶   title                        │
│  product.handle          ──▶   handle                       │
│  product.thumbnail       ──▶   thumbnail                    │
│  product.description     ──▶   description                  │
│                                                              │
│  product.categories[]    ──▶   category_ids[]               │
│    └─ .id                      category_names[]             │
│    └─ .name                                                 │
│                                                              │
│  product.collection      ──▶   collection_ids[]             │
│    └─ .id                      collection_names[]           │
│    └─ .title                                                │
│                                                              │
│  product.tags[]          ──▶   tag_ids[]                    │
│    └─ .id                      tag_values[]                 │
│    └─ .value                                                │
│                                                              │
│  product.variants[]      ──▶   min_price (计算最小值)        │
│    └─ .prices[]                max_price (计算最大值)        │
│       └─ .amount               variant_count                │
│                                                              │
│  product.metadata        ──▶   meta_* (扁平化)               │
│    └─ { material: "X" }        meta_material: "X"           │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```


---

## 六、搜索能力设计

### 6.1 搜索功能矩阵

| 功能 | 描述 | 实现方式 |
|------|------|----------|
| **全文搜索** | 关键词匹配产品标题、描述 | 搜索引擎全文索引 |
| **Faceted 过滤** | 多维度筛选 | 聚合查询 + 过滤 |
| **价格区间** | 按价格范围过滤 | Range Query |
| **排序** | 相关性、价格、时间 | Sort + Score |
| **分页** | 大数据量分页浏览 | From/Size |

### 6.2 Facet 设计

```
┌─────────────────────────────────────────────────────────────┐
│                    Facet Configuration                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Value Facets (值过滤)                               │    │
│  │  ─────────────────────                              │    │
│  │                                                     │    │
│  │  category_names    ──▶  [Living Room (12)]          │    │
│  │                         [Bedroom (8)]               │    │
│  │                         [Office (5)]                │    │
│  │                                                     │    │
│  │  collection_names  ──▶  [Summer Sale (15)]          │    │
│  │                         [New Arrivals (10)]         │    │
│  │                                                     │    │
│  │  meta_material     ──▶  [Leather (20)]              │    │
│  │                         [Fabric (35)]               │    │
│  │                         [Wood (12)]                 │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Range Facets (区间过滤)                             │    │
│  │  ─────────────────────                              │    │
│  │                                                     │    │
│  │  min_price         ──▶  [Under $500 (25)]           │    │
│  │                         [$500 - $1,000 (18)]        │    │
│  │                         [$1,000 - $2,000 (12)]      │    │
│  │                         [Over $2,000 (8)]           │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Disjunctive Facets (OR 逻辑)                        │    │
│  │  ─────────────────────                              │    │
│  │                                                     │    │
│  │  选择 "Living Room" OR "Bedroom"                    │    │
│  │  = 显示属于任一分类的产品                            │    │
│  │                                                     │    │
│  │  而非 "Living Room" AND "Bedroom"                   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 搜索字段权重

```
┌─────────────────────────────────────────────────────────────┐
│                  Search Field Weights                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  字段              权重    说明                              │
│  ────              ────    ────                              │
│  title             5       标题匹配最重要                     │
│  subtitle          3       副标题次之                        │
│  description       2       描述匹配权重较低                   │
│                                                              │
│  示例:                                                       │
│  搜索 "leather sofa"                                        │
│                                                              │
│  Product A: title="Leather Sofa"        ──▶ Score: 高       │
│  Product B: description="...leather..." ──▶ Score: 低       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```


---

## 七、整体架构视图

### 7.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        System Architecture                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                      Presentation Layer                      │    │
│  │  ┌─────────────────────┐    ┌─────────────────────┐         │    │
│  │  │     Admin UI        │    │     Storefront      │         │    │
│  │  │   (管理后台)         │    │    (用户前台)        │         │    │
│  │  │                     │    │                     │         │    │
│  │  │  • 产品管理          │    │  • 搜索框           │         │    │
│  │  │  • 手动同步按钮      │    │  • 过滤器           │         │    │
│  │  │                     │    │  • 产品列表         │         │    │
│  │  └──────────┬──────────┘    └──────────┬──────────┘         │    │
│  └─────────────┼──────────────────────────┼─────────────────────┘    │
│                │                          │                          │
│                │ REST API                 │ Direct Query             │
│                ▼                          ▼                          │
│  ┌─────────────────────────┐    ┌─────────────────────────┐         │
│  │    Product Domain       │    │     Search Domain       │         │
│  │    ──────────────       │    │     ─────────────       │         │
│  │                         │    │                         │         │
│  │  ┌─────────────────┐    │    │  ┌─────────────────┐    │         │
│  │  │  Product Module │    │    │  │  Search Module  │    │         │
│  │  │  ─────────────  │    │    │  │  ────────────   │    │         │
│  │  │  • CRUD 操作    │    │    │  │  • 索引管理     │    │         │
│  │  │  • 业务规则     │    │    │  │  • 文档同步     │    │         │
│  │  └─────────────────┘    │    │  └─────────────────┘    │         │
│  │           │              │    │           │             │         │
│  │           ▼              │    │           ▼             │         │
│  │  ┌─────────────────┐    │    │  ┌─────────────────┐    │         │
│  │  │   PostgreSQL    │    │    │  │   OpenSearch    │    │         │
│  │  │   (数据存储)     │    │    │  │   (搜索引擎)     │    │         │
│  │  └─────────────────┘    │    │  └─────────────────┘    │         │
│  │                         │    │                         │         │
│  └────────────┬────────────┘    └─────────────────────────┘         │
│               │                                                      │
│               │ Domain Events                                        │
│               ▼                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                     Event Bus                                │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │    │
│  │  │ Product      │  │ Product      │  │ Product      │       │    │
│  │  │ Created      │  │ Updated      │  │ Deleted      │       │    │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘       │    │
│  └─────────┼─────────────────┼─────────────────┼────────────────┘    │
│            │                 │                 │                     │
│            └─────────────────┼─────────────────┘                     │
│                              ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                   Event Handlers                             │    │
│  │  ┌─────────────────────────────────────────────────────┐    │    │
│  │  │              Sync Workflow                           │    │    │
│  │  │  Query ──▶ Transform ──▶ Index/Delete               │    │    │
│  │  └─────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```


### 7.2 数据流向

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Data Flow Overview                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  写入路径 (Write Path)                                               │
│  ─────────────────────                                               │
│                                                                      │
│  Admin ──▶ Product API ──▶ PostgreSQL ──▶ Event ──▶ OpenSearch      │
│                                                                      │
│  1. 管理员通过 Admin UI 操作产品                                      │
│  2. Product Domain 处理业务逻辑，持久化到 PostgreSQL                  │
│  3. 发布领域事件                                                      │
│  4. Event Handler 触发同步流程                                        │
│  5. 数据转换后写入 OpenSearch                                         │
│                                                                      │
│  ─────────────────────────────────────────────────────────────────   │
│                                                                      │
│  读取路径 (Read Path)                                                │
│  ─────────────────────                                               │
│                                                                      │
│  Storefront ──▶ OpenSearch ──▶ Search Results                       │
│                                                                      │
│  1. 用户在 Storefront 输入搜索条件                                    │
│  2. 前端直接查询 OpenSearch（绕过后端 API）                           │
│  3. 返回搜索结果和 Facet 聚合                                         │
│                                                                      │
│  ─────────────────────────────────────────────────────────────────   │
│                                                                      │
│  关键设计决策:                                                        │
│  • 前端直连搜索引擎，减少网络跳转，提升性能                            │
│  • 写入通过事件异步同步，不阻塞主流程                                  │
│  • 搜索索引是 PostgreSQL 数据的投影，非权威数据源                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 八、关键设计决策

### 8.1 为什么选择事件驱动而非同步调用？

| 方案 | 优点 | 缺点 |
|------|------|------|
| **同步调用** | 强一致性 | 增加响应延迟、耦合度高 |
| **事件驱动** ✓ | 松耦合、不阻塞主流程 | 最终一致性 |

**决策理由**：
- 搜索结果允许短暂延迟（秒级）
- 产品操作不应因搜索索引失败而失败
- 便于未来扩展更多事件消费者

### 8.2 为什么前端直连搜索引擎？

| 方案 | 优点 | 缺点 |
|------|------|------|
| **通过后端代理** | 可加权限控制 | 增加延迟、后端负载 |
| **前端直连** ✓ | 低延迟、减少后端压力 | 需处理 CORS |

**决策理由**：
- 产品搜索是公开数据，无需权限控制
- 搜索是高频操作，直连可显著降低延迟
- 搜索引擎本身具备高并发能力

### 8.3 为什么使用扁平化文档结构？

| 方案 | 优点 | 缺点 |
|------|------|------|
| **保持嵌套结构** | 与源数据一致 | 查询复杂、性能差 |
| **扁平化结构** ✓ | 查询简单、性能好 | 需要转换逻辑 |

**决策理由**：
- 搜索引擎对扁平结构优化更好
- Facet 聚合需要顶层字段
- 转换逻辑集中在同步流程，易于维护


---

## 九、可靠性保障

### 9.1 数据一致性保障

```
┌─────────────────────────────────────────────────────────────┐
│              Consistency Guarantee Mechanisms                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  1. 实时同步 (Event-Driven)                         │    │
│  │  ─────────────────────────                          │    │
│  │  • 产品变更触发事件                                  │    │
│  │  • 事件处理器自动同步                                │    │
│  │  • 延迟: 秒级                                       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  2. 手动全量同步 (Admin Trigger)                    │    │
│  │  ─────────────────────────                          │    │
│  │  • 管理员可手动触发全量同步                          │    │
│  │  • 用于修复数据不一致                                │    │
│  │  • 支持分页批量处理                                  │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  3. 定时任务 (可选扩展)                              │    │
│  │  ─────────────────────────                          │    │
│  │  • 定期全量校验                                      │    │
│  │  • 自动修复漂移数据                                  │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 9.2 故障处理策略

| 故障场景 | 影响 | 处理策略 |
|----------|------|----------|
| 搜索引擎不可用 | 搜索功能降级 | 前端显示友好提示，不影响其他功能 |
| 事件处理失败 | 数据不一致 | 重试机制 + 手动同步兜底 |
| 网络分区 | 同步延迟 | 事件队列缓冲，恢复后继续处理 |

---

## 十、扩展性考虑

### 10.1 水平扩展能力

```
┌─────────────────────────────────────────────────────────────┐
│                  Scalability Design                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Product Domain                Search Domain                 │
│  ──────────────                ─────────────                 │
│                                                              │
│  ┌─────────────┐              ┌─────────────┐               │
│  │ PostgreSQL  │              │ OpenSearch  │               │
│  │             │              │   Cluster   │               │
│  │  • 主从复制  │              │             │               │
│  │  • 读写分离  │              │  • 分片     │               │
│  │             │              │  • 副本     │               │
│  └─────────────┘              │  • 自动扩容 │               │
│                               └─────────────┘               │
│                                                              │
│  扩展策略:                                                   │
│  • Product Domain: 垂直扩展为主，读写分离                    │
│  • Search Domain: 水平扩展，增加分片和副本                   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 10.2 功能扩展点

| 扩展方向 | 实现方式 |
|----------|----------|
| 新增 Facet 维度 | 修改文档结构 + 前端配置 |
| 搜索建议/自动补全 | 添加 Suggest 索引 |
| 搜索分析/热词 | 接入搜索日志分析 |
| 个性化排序 | 引入用户行为数据 |
| 多语言搜索 | 配置多语言分词器 |


---

## 十一、总结

### 11.1 架构设计亮点

| 设计模式 | 应用场景 | 带来的价值 |
|----------|----------|------------|
| **领域驱动设计** | 识别 Product 和 Search 两个领域 | 关注点分离，独立演进 |
| **事件驱动架构** | 领域间通过事件通信 | 松耦合，异步处理 |
| **CQRS 思想** | 读写分离到不同存储 | 各自优化，性能提升 |
| **流程编排** | 同步逻辑拆分为步骤 | 可观测、可重试、可扩展 |

### 11.2 解决的业务问题

```
┌─────────────────────────────────────────────────────────────┐
│                  Before vs After                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Before (痛点)                 After (解决方案)              │
│  ─────────────                 ────────────────              │
│                                                              │
│  ❌ 只能精确匹配         ──▶   ✅ 全文搜索 + 模糊匹配        │
│  ❌ 单一过滤维度         ──▶   ✅ 多维度 Faceted 过滤        │
│  ❌ 大数据量查询慢       ──▶   ✅ 毫秒级响应                 │
│  ❌ 无相关性排序         ──▶   ✅ 智能相关性排序             │
│  ❌ 搜索条件不可分享     ──▶   ✅ URL 状态同步               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 11.3 技术选型总结

| 层次 | 技术选择 | 选择理由 |
|------|----------|----------|
| **产品数据存储** | PostgreSQL | 事务支持、数据一致性 |
| **搜索引擎** | OpenSearch | 全文搜索、Facet 聚合、高性能 |
| **事件总线** | 内置 Event Bus | 轻量级、与框架集成 |
| **前端搜索 UI** | Elastic Search UI | 成熟的搜索 UI 组件库 |

---

## 附录：Demo 演示流程

### A. 问题展示
1. 展示原生搜索的局限性（只能精确匹配）
2. 说明业务痛点

### B. 架构讲解
1. 介绍两个领域的划分
2. 解释事件驱动的设计

### C. 实时同步演示
1. 在 Admin 创建/更新产品
2. 观察事件触发
3. 查看搜索索引更新

### D. 搜索体验演示
1. 全文搜索功能
2. Faceted 过滤
3. URL 状态同步
4. 排序功能

### E. 运维能力演示
1. Admin Widget 手动同步
2. 健康检查
